# Vercel Deployment Notifications via Telegram
#
# Sends Telegram notifications when Vercel deployments succeed or fail.
# Supports both Production (push to main) and Preview (pull requests).
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)
#
# Setup:
#   1. Run `yarn telegram-setup` to get your chat ID
#   2. Add secrets in GitHub: Settings â†’ Secrets and variables â†’ Actions

name: Deployment Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      deployments: read
      statuses: read
    env:
      IS_PRODUCTION: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    steps:
      - name: Set deployment type
        id: deploy-type
        run: |
          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            echo "env=Production" >> $GITHUB_OUTPUT
            echo "emoji=ðŸš€" >> $GITHUB_OUTPUT
            echo "type=Production" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "env=Preview" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ‘€" >> $GITHUB_OUTPUT
            echo "type=Preview (PR #${{ github.event.pull_request.number }})" >> $GITHUB_OUTPUT
            # For PRs, Vercel uses the head commit SHA, not the merge commit
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Send deployment started notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          # Validate required environment variables
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "::error::TELEGRAM_BOT_TOKEN secret is not set. Please configure it in GitHub repository secrets."
            exit 1
          fi
          if [ -z "$CHAT_ID_RAW" ]; then
            echo "::error::Neither VERCEL_TELEGRAM_CHAT_ID nor LOCAL_TELEGRAM_CHAT_ID secret is set. Please configure at least one in GitHub repository secrets."
            exit 1
          fi
          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Could not determine commit SHA from deploy-type step."
            exit 1
          fi

          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          # Validate parsed chat ID
          if [ -z "$CHAT_ID" ]; then
            echo "::error::Failed to parse CHAT_ID from CHAT_ID_RAW: '$CHAT_ID_RAW'"
            exit 1
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            COMMIT_COUNT=$(echo "$COMMITS_JSON" | jq 'length')
            if [ -z "$COMMIT_COUNT" ] || ! [[ "$COMMIT_COUNT" =~ ^[0-9]+$ ]]; then
              echo "::warning::Could not parse commit count from COMMITS_JSON, defaulting to 1"
              COMMIT_COUNT=1
            fi

            if [ "$COMMIT_COUNT" -eq 1 ]; then
              # Single commit - show commit name and Open Commit button
              COMMIT_MSG=$(echo "$HEAD_COMMIT_MESSAGE" | head -1)

              read -r -d '' MESSAGE << 'MSGEOF' || true
          ðŸš€ *Production Deployment Started*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ Commit: COMMIT_MSG_PLACEHOLDER
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
              MESSAGE="${MESSAGE//COMMIT_MSG_PLACEHOLDER/$COMMIT_MSG}"

              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ“‹ Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            else
              # Multiple commits - show count with 2 buttons
              read -r -d '' MESSAGE << 'MSGEOF' || true
          ðŸš€ *Production Deployment Started*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ Commits: COMMIT_COUNT_PLACEHOLDER commits
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
              MESSAGE="${MESSAGE//COMMIT_COUNT_PLACEHOLDER/$COMMIT_COUNT}"

              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ“Š Open Diff","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}"},{"text":"ðŸ“‹ Show Commits","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}/commits"}]]}'
            fi

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            PR_TITLE="${{ github.event.pull_request.title }}"
            read -r -d '' MESSAGE << 'MSGEOF' || true
          ðŸ‘€ *Preview Deployment Started (PR #${{ github.event.pull_request.number }})*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ PR: PR_TITLE_PLACEHOLDER
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
            MESSAGE="${MESSAGE//PR_TITLE_PLACEHOLDER/$PR_TITLE}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Wait for Vercel deployment
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: ${{ steps.deploy-type.outputs.env }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
        run: |
          echo "Waiting for Vercel $DEPLOY_ENV deployment (SHA: ${COMMIT_SHA::7})..."
          for i in {1..40}; do
            DEPLOY_URL=$(gh api repos/${{ github.repository }}/deployments \
              --jq ".[] | select(.sha==\"${COMMIT_SHA}\" and .environment==\"$DEPLOY_ENV\") | .id" \
              | head -1)

            if [ -n "$DEPLOY_URL" ]; then
              STATUS=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].state // "pending"')
              URL=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].environment_url // ""')
              DESCRIPTION=$(gh api repos/${{ github.repository }}/deployments/${DEPLOY_URL}/statuses --jq '.[0].description // ""')
              echo "Deployment status: $STATUS"

              if [ "$STATUS" = "success" ]; then
                echo "url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment successful: $URL"
                exit 0
              elif [ "$STATUS" = "failure" ] || [ "$STATUS" = "error" ]; then
                echo "error=$DESCRIPTION" >> $GITHUB_OUTPUT
                echo "log_url=$URL" >> $GITHUB_OUTPUT
                echo "Deployment failed: $DESCRIPTION"
                exit 1
              fi
            fi

            echo "Waiting... (attempt $i/40)"
            sleep 15
          done
          echo "error=Timeout waiting for deployment" >> $GITHUB_OUTPUT
          echo "Timeout waiting for deployment"
          exit 1

      - name: Send deployment success notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          # Validate required environment variables
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "::error::TELEGRAM_BOT_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$CHAT_ID_RAW" ]; then
            echo "::error::Chat ID secret is not set"
            exit 1
          fi

          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          if [ -z "$CHAT_ID" ]; then
            echo "::error::Failed to parse CHAT_ID"
            exit 1
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            COMMIT_COUNT=$(echo "$COMMITS_JSON" | jq 'length')
            if [ -z "$COMMIT_COUNT" ] || ! [[ "$COMMIT_COUNT" =~ ^[0-9]+$ ]]; then
              COMMIT_COUNT=1
            fi

            if [ "$COMMIT_COUNT" -eq 1 ]; then
              # Single commit - show commit name and Open Commit button
              COMMIT_MSG=$(echo "$HEAD_COMMIT_MESSAGE" | head -1)

              read -r -d '' MESSAGE << 'MSGEOF' || true
          âœ… *Production Deployment Complete - Live*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ Commit: COMMIT_MSG_PLACEHOLDER
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
              MESSAGE="${MESSAGE//COMMIT_MSG_PLACEHOLDER/$COMMIT_MSG}"

              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ“‹ Open Commit","url":"${{ github.server_url }}/${{ github.repository }}/commit/'"${COMMIT_SHA}"'"}]]}'
            else
              # Multiple commits - show count with 2 buttons
              read -r -d '' MESSAGE << 'MSGEOF' || true
          âœ… *Production Deployment Complete - Live*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ Commits: COMMIT_COUNT_PLACEHOLDER commits
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
              MESSAGE="${MESSAGE//COMMIT_COUNT_PLACEHOLDER/$COMMIT_COUNT}"

              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ“Š Open Diff","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}"},{"text":"ðŸ“‹ Show Commits","url":"${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.event.after }}/commits"}]]}'
            fi

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          else
            PR_TITLE="${{ github.event.pull_request.title }}"
            read -r -d '' MESSAGE << 'MSGEOF' || true
          âœ… *Preview Deployment Ready (PR #${{ github.event.pull_request.number }})*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ PR: PR_TITLE_PLACEHOLDER
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
            MESSAGE="${MESSAGE//PR_TITLE_PLACEHOLDER/$PR_TITLE}"

            KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ”— Open URL","url":"${{ steps.deployment.outputs.url }}"},{"text":"ðŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "parse_mode=Markdown" \
              -d "text=${MESSAGE}" \
              -d "reply_markup=${KEYBOARD}"
          fi

      - name: Send failure notification
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.VERCEL_TELEGRAM_CHAT_ID || secrets.LOCAL_TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ steps.deploy-type.outputs.sha }}
          ERROR_MSG: ${{ steps.deployment.outputs.error }}
          LOG_URL: ${{ steps.deployment.outputs.log_url }}
        run: |
          # Validate required environment variables
          if [ -z "$TELEGRAM_BOT_TOKEN" ]; then
            echo "::error::TELEGRAM_BOT_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "$CHAT_ID_RAW" ]; then
            echo "::error::Chat ID secret is not set"
            exit 1
          fi

          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          if [ -z "$CHAT_ID" ]; then
            echo "::error::Failed to parse CHAT_ID"
            exit 1
          fi

          # Truncate error message if too long
          ERROR_PREVIEW="${ERROR_MSG:0:200}"
          if [ ${#ERROR_MSG} -gt 200 ]; then
            ERROR_PREVIEW="${ERROR_PREVIEW}..."
          fi

          if [ "${{ env.IS_PRODUCTION }}" == "true" ]; then
            read -r -d '' MESSAGE << 'MSGEOF' || true
          âŒ *Production Deployment Failed*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          ðŸ’¥ *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ” View Logs","url":"'"${LOG_URL}"'"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ” View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'
            fi
          else
            PR_TITLE="${{ github.event.pull_request.title }}"
            read -r -d '' MESSAGE << 'MSGEOF' || true
          âŒ *Preview Deployment Failed (PR #${{ github.event.pull_request.number }})*

          ðŸ“¦ Repository: ${{ github.repository }}
          ðŸ“ PR: PR_TITLE_PLACEHOLDER
          ðŸ‘¤ Author: ${{ github.actor }}
          MSGEOF
            MESSAGE="${MESSAGE//PR_TITLE_PLACEHOLDER/$PR_TITLE}"

            if [ -n "$ERROR_PREVIEW" ]; then
              MESSAGE="${MESSAGE}

          ðŸ’¥ *Error:* ${ERROR_PREVIEW}"
            fi

            if [ -n "$LOG_URL" ]; then
              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ” View Logs","url":"'"${LOG_URL}"'"},{"text":"ðŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            else
              KEYBOARD='{"inline_keyboard":[[{"text":"ðŸ” View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"},{"text":"ðŸ“‹ Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"}]]}'
            fi
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            ${THREAD_PARAM} \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}" \
            -d "disable_web_page_preview=true"
