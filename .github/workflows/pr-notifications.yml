name: PR Notifications

# Trigger on PR events
on:
  pull_request:
    types: [opened, closed, reopened, review_requested, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    # Only run if TELEGRAM_NOTIFICATIONS_ENABLED is set
    if: ${{ vars.TELEGRAM_NOTIFICATIONS_ENABLED == 'true' }}

    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID_RAW: ${{ secrets.GH_TELEGRAM_CHAT_ID || secrets.TELEGRAM_CHAT_ID }}
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          # Pass these as env vars to avoid shell escaping issues with quotes in titles
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_USER: ${{ github.event.pull_request.user.login }}
          PR_MERGED: ${{ github.event.pull_request.merged }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
          REQUESTED_REVIEWER: ${{ github.event.requested_reviewer.login }}
          REVIEW_USER: ${{ github.event.review.user.login }}
          REVIEW_STATE: ${{ github.event.review.state }}
          REVIEW_URL: ${{ github.event.review.html_url }}
        run: |
          # Parse chat ID and optional thread ID (format: chatId or chatId:threadId)
          if [[ "$CHAT_ID_RAW" == *":"* ]]; then
            TELEGRAM_CHAT_ID="${CHAT_ID_RAW%:*}"
            THREAD_ID="${CHAT_ID_RAW##*:}"
            THREAD_PARAM="-d message_thread_id=${THREAD_ID}"
          else
            TELEGRAM_CHAT_ID="$CHAT_ID_RAW"
            THREAD_PARAM=""
          fi

          MESSAGE=""

          # Escape special characters for Telegram Markdown and URL encoding
          # Replace newlines and special chars that break the message
          SAFE_TITLE=$(echo "$PR_TITLE" | sed 's/[_*`\[]/\\&/g' | tr '\n' ' ')

          # Pull request events
          if [ "$EVENT_NAME" = "pull_request" ]; then
            case "$EVENT_ACTION" in
              opened)
                MESSAGE="üîÄ *New PR #${PR_NUMBER}*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${PR_USER}%0Aüîó ${PR_URL}"
                ;;
              closed)
                if [ "$PR_MERGED" = "true" ]; then
                  MESSAGE="üéâ *PR #${PR_NUMBER} Merged*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${MERGED_BY}%0Aüîó ${PR_URL}"
                else
                  MESSAGE="‚ùå *PR #${PR_NUMBER} Closed*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${SENDER_LOGIN}%0Aüîó ${PR_URL}"
                fi
                ;;
              reopened)
                MESSAGE="üîÑ *PR #${PR_NUMBER} Reopened*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${SENDER_LOGIN}%0Aüîó ${PR_URL}"
                ;;
              review_requested)
                MESSAGE="üëÄ *Review Requested on PR #${PR_NUMBER}*%0A%0A${SAFE_TITLE}%0A%0AReviewer: ${REQUESTED_REVIEWER}%0Aüîó ${PR_URL}"
                ;;
              ready_for_review)
                MESSAGE="‚úÖ *PR #${PR_NUMBER} Ready for Review*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${PR_USER}%0Aüîó ${PR_URL}"
                ;;
            esac
          fi

          # PR review events
          if [ "$EVENT_NAME" = "pull_request_review" ]; then
            case "$REVIEW_STATE" in
              approved)
                MESSAGE="‚úÖ *PR #${PR_NUMBER} Approved*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${REVIEW_USER}%0Aüîó ${REVIEW_URL}"
                ;;
              changes_requested)
                MESSAGE="üîÑ *Changes Requested on PR #${PR_NUMBER}*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${REVIEW_USER}%0Aüîó ${REVIEW_URL}"
                ;;
              commented)
                MESSAGE="üí¨ *Review Comment on PR #${PR_NUMBER}*%0A%0A${SAFE_TITLE}%0A%0Aüë§ by ${REVIEW_USER}%0Aüîó ${REVIEW_URL}"
                ;;
            esac
          fi

          # Send the message if we have one
          if [ -n "$MESSAGE" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              ${THREAD_PARAM} \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
          fi
