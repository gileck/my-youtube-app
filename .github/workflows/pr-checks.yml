# PR Code Quality Checks
#
# Runs all code quality checks in parallel on pull requests.
# Each check runs as a separate job for better visibility and faster execution.
#
# Required GitHub Secrets (set via `yarn setup-github-secrets`):
#   - TELEGRAM_BOT_TOKEN: Your Telegram bot token
#   - LOCAL_TELEGRAM_CHAT_ID: Chat ID to receive notifications (from LOCAL_TELEGRAM_CHAT_ID in .env)

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  # TypeScript type checking
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run TypeScript check
        id: check
        run: |
          set +e
          OUTPUT=$(yarn ts 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          # Save output for artifact
          echo "$OUTPUT" > typescript-output.txt
          exit $EXIT_CODE

      - name: Upload error output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: typescript-errors
          path: typescript-output.txt
          retention-days: 1

  # ESLint code quality
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run ESLint check
        id: check
        run: |
          set +e
          OUTPUT=$(yarn lint 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          # Save output for artifact
          echo "$OUTPUT" > eslint-output.txt
          exit $EXIT_CODE

      - name: Upload error output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-errors
          path: eslint-output.txt
          retention-days: 1

  # Circular dependency detection
  circular:
    name: Circular Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run circular dependency check
        id: check
        run: |
          set +e
          OUTPUT=$(yarn check:circular 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          # Save output for artifact
          echo "$OUTPUT" > circular-output.txt
          exit $EXIT_CODE

      - name: Upload error output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: circular-errors
          path: circular-output.txt
          retention-days: 1

  # Unused dependencies detection
  unused:
    name: Unused Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - run: yarn install

      - name: Run unused dependencies check
        id: check
        run: |
          set +e
          OUTPUT=$(yarn check:unused:ci --no-config-hints 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          # Save output for artifact
          echo "$OUTPUT" > unused-output.txt
          exit $EXIT_CODE

      - name: Upload error output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unused-errors
          path: unused-output.txt
          retention-days: 1

  # E2E workflow tests (in-memory MongoDB, no external services)
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for yarn.lock
        id: yarn-lock
        run: |
          if [ -f yarn.lock ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: ${{ steps.yarn-lock.outputs.exists == 'true' && 'yarn' || '' }}

      - name: Cache MongoDB binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/mongodb-binaries
          key: mongodb-binaries-${{ runner.os }}

      - run: yarn install

      - name: Run E2E tests
        id: check
        run: |
          set +e
          OUTPUT=$(yarn test:e2e 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"
          # Save output for artifact
          echo "$OUTPUT" > e2e-output.txt
          exit $EXIT_CODE

      - name: Upload error output
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-errors
          path: e2e-output.txt
          retention-days: 1

  # Summary job - runs after all checks complete
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [typescript, lint, circular, unused, e2e]
    if: always()
    steps:
      - name: Download error artifacts
        uses: actions/download-artifact@v4
        with:
          path: errors
        continue-on-error: true

      - name: Check results and build comment
        id: results
        run: |
          # Collect results from all jobs
          TS_RESULT="${{ needs.typescript.result }}"
          LINT_RESULT="${{ needs.lint.result }}"
          CIRCULAR_RESULT="${{ needs.circular.result }}"
          UNUSED_RESULT="${{ needs.unused.result }}"
          E2E_RESULT="${{ needs.e2e.result }}"

          # Build failure list
          FAILURES=""
          if [ "$TS_RESULT" != "success" ]; then FAILURES="$FAILURES TypeScript"; fi
          if [ "$LINT_RESULT" != "success" ]; then FAILURES="$FAILURES ESLint"; fi
          if [ "$CIRCULAR_RESULT" != "success" ]; then FAILURES="$FAILURES Circular"; fi
          if [ "$UNUSED_RESULT" != "success" ]; then FAILURES="$FAILURES Unused"; fi
          if [ "$E2E_RESULT" != "success" ]; then FAILURES="$FAILURES E2E"; fi

          # Set status output
          if [ -z "$FAILURES" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
          echo "failures=$FAILURES" >> $GITHUB_OUTPUT

          # Build error details section
          ERROR_DETAILS=""

          if [ -f "errors/typescript-errors/typescript-output.txt" ]; then
            TS_ERRORS=$(cat errors/typescript-errors/typescript-output.txt | grep -E "error TS|Error:" | head -10)
            if [ -n "$TS_ERRORS" ]; then
              ERROR_DETAILS="${ERROR_DETAILS}
          ### TypeScript Errors
          \`\`\`
          ${TS_ERRORS}
          \`\`\`
          "
            fi
          fi

          if [ -f "errors/eslint-errors/eslint-output.txt" ]; then
            LINT_ERRORS=$(cat errors/eslint-errors/eslint-output.txt | grep -E "Error:|Warning:" | head -10)
            if [ -n "$LINT_ERRORS" ]; then
              ERROR_DETAILS="${ERROR_DETAILS}
          ### ESLint Errors
          \`\`\`
          ${LINT_ERRORS}
          \`\`\`
          "
            fi
          fi

          if [ -f "errors/circular-errors/circular-output.txt" ]; then
            CIRCULAR_ERRORS=$(cat errors/circular-errors/circular-output.txt | grep -E "circular|>" | head -10)
            if [ -n "$CIRCULAR_ERRORS" ]; then
              ERROR_DETAILS="${ERROR_DETAILS}
          ### Circular Dependencies
          \`\`\`
          ${CIRCULAR_ERRORS}
          \`\`\`
          "
            fi
          fi

          if [ -f "errors/unused-errors/unused-output.txt" ]; then
            UNUSED_ERRORS=$(cat errors/unused-errors/unused-output.txt | grep -v "^$" | head -10)
            if [ -n "$UNUSED_ERRORS" ]; then
              ERROR_DETAILS="${ERROR_DETAILS}
          ### Unused Dependencies
          \`\`\`
          ${UNUSED_ERRORS}
          \`\`\`
          "
            fi
          fi

          if [ -f "errors/e2e-errors/e2e-output.txt" ]; then
            E2E_ERRORS=$(cat errors/e2e-errors/e2e-output.txt | grep -E "FAIL|Error|AssertionError|expected|‚úó|√ó" | head -15)
            if [ -n "$E2E_ERRORS" ]; then
              ERROR_DETAILS="${ERROR_DETAILS}
          ### E2E Test Failures
          \`\`\`
          ${E2E_ERRORS}
          \`\`\`
          "
            fi
          fi

          # Save error details to file (multiline output)
          echo "$ERROR_DETAILS" > error_details.txt

      - name: Comment on PR (failure)
        if: steps.results.outputs.status == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failures = '${{ steps.results.outputs.failures }}'.trim().split(' ').filter(Boolean);
            const failureList = failures.map(f => `- ${f}`).join('\n');

            let errorDetails = '';
            try {
              errorDetails = fs.readFileSync('error_details.txt', 'utf8');
            } catch (e) {
              // No error details file
            }

            const body = `## :x: Code Quality Checks Failed

            **Failed checks:**
            ${failureList}

            | Check | Status |
            |-------|--------|
            | TypeScript | ${{ needs.typescript.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | ESLint | ${{ needs.lint.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | Circular Dependencies | ${{ needs.circular.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | Unused Dependencies | ${{ needs.unused.result == 'success' && ':white_check_mark:' || ':x:' }} |
            | E2E Tests | ${{ needs.e2e.result == 'success' && ':white_check_mark:' || ':x:' }} |

            ${errorDetails ? `<details>
            <summary>üìã Error Details (click to expand)</summary>

            ${errorDetails}

            </details>` : ''}

            > Click on the failed job above to see full details.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR (success)
        if: steps.results.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## :white_check_mark: Code Quality Checks Passed\n\nAll checks completed successfully.'
            });

      - name: Send Telegram notification (failure)
        if: steps.results.outputs.status == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.LOCAL_TELEGRAM_CHAT_ID }}
        run: |
          FAILURES="${{ steps.results.outputs.failures }}"

          MESSAGE="‚ö†Ô∏è *Code Checks Failed (PR #${{ github.event.pull_request.number }})*

          üìù PR: ${{ github.event.pull_request.title }}
          ‚ùå Failed: ${FAILURES}
          üë§ Author: ${{ github.actor }}"

          KEYBOARD='{"inline_keyboard":[[{"text":"üìã Open PR","url":"${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"},{"text":"üîç View Logs","url":"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]]}'

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${MESSAGE}" \
            -d "reply_markup=${KEYBOARD}"
